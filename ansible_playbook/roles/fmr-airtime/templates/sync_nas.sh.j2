#!/bin/bash
# ATTENTION : fichier géré par Ansible ! Les modifications seront perdues.

SRC="{{ nas_mount }}/"  # The trailing "/" is important!
DST="{{ library_path }}"

PID="/var/lock/sync_nas.pid"

# Kill a previously launched instance
if [ -s "$PID" ]; then
  kill $(cat "$PID")
fi

# Keep track of our PID so we can kill it later
echo $$ > "$PID"

mount "$SRC" 2>/dev/null \
  && rsync -aq --del \
    --chmod="ug=rwX,o=rX" \
    --exclude=lost+found \
    "$SRC" "$DST"

# Unmount NAS even if rsync failed
umount "$SRC" 2>/dev/null

# Ended normally, remove our PID file
rm "$PID"

